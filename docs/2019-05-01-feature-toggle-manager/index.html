<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Hugo 0.80.0" />

  <title>Usando Toggles com Togglz e Spring Boot &middot; NullPointer</title>

  <meta name="description" content="Uso de Togglz com Spring Boot" />

  

<meta itemprop="name" content="Usando Toggles com Togglz e Spring Boot">
<meta itemprop="description" content="Uso de Togglz com Spring Boot">
<meta itemprop="datePublished" content="2019-05-01T18:00:50+00:00" />
<meta itemprop="dateModified" content="2019-05-01T18:00:50+00:00" />
<meta itemprop="wordCount" content="1039">
<meta itemprop="image" content="http://rpinheiro.dev/images/profile.png"/>



<meta itemprop="keywords" content="Java,Desenvolvimento,togglz,spring-boot," />


<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://rpinheiro.dev/images/profile.png"/>

<meta name="twitter:title" content="Usando Toggles com Togglz e Spring Boot"/>
<meta name="twitter:description" content="Uso de Togglz com Spring Boot"/>


<meta property="og:title" content="Usando Toggles com Togglz e Spring Boot" />
<meta property="og:description" content="Uso de Togglz com Spring Boot" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://rpinheiro.dev/2019-05-01-feature-toggle-manager/" />
<meta property="og:image" content="http://rpinheiro.dev/images/profile.png"/>
<meta property="article:published_time" content="2019-05-01T18:00:50+00:00" />
<meta property="article:modified_time" content="2019-05-01T18:00:50+00:00" />



<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type":"Person",
      "@id": "http://rpinheiro.dev/#author",
      "name": "Rodrigo Pinheiro",
      "image": {
        "@type":"ImageObject",
        
        "url": "http://rpinheiro.dev/images/profile.png"
        
      },
      "description": "..."
    },
    {
      "@type": "WebSite",
      "@id": "http://rpinheiro.dev/#website",
      "url": "http://rpinheiro.dev/",
      "name": "NullPointer",
      "description": "...",
      "publisher": {
        "@id": "http://rpinheiro.dev/#author"
      },
      "inLanguage": ""
    },
    {
      "@type": "ImageObject",
      "url": "http://rpinheiro.dev/images/profile.png",
      "caption": "NullPointer"
    },
    {
      "@type": "WebPage",
      "@id": "http://rpinheiro.dev/2019-05-01-feature-toggle-manager/#webpage",
      "url": "http://rpinheiro.dev/2019-05-01-feature-toggle-manager/",
      "name": "Usando Toggles com Togglz e Spring Boot",
      "isPartOf": {
        "@id": "http://rpinheiro.dev/#website"
      },
      "about": {
         "@id": "http://rpinheiro.dev/#author"
      },
      "datePublished": "2019-05-01T18:00:50+00:00",
      "dateModified": "2019-05-01T18:00:50+00:00",
      "description": "Uso de Togglz com Spring Boot",
      "inLanguage": "",
      "potentialAction": [
        {
          "@type": "ReadAction",
          "target": [
            "http://rpinheiro.dev/2019-05-01-feature-toggle-manager/"
          ]
        }
      ]
    },
    {
      "@type": "Article",
      "isPartOf": {
        "@id": "http://rpinheiro.dev/2019-05-01-feature-toggle-manager/#webpage"
      },
      "mainEntityOfPage": {
        "@id": "http://rpinheiro.dev/2019-05-01-feature-toggle-manager/#webpage"
      },
      "headline": "Usando Toggles com Togglz e Spring Boot",
      "datePublished": "2019-05-01T18:00:50+00:00",
      "dateModified": "2019-05-01T18:00:50+00:00",
      "publisher": {
        "@id": "http://rpinheiro.dev/#author"
      },
      "keywords": [
        "Java",
        "Desenvolvimento",
        "togglz",
        "spring-boot"
      ],
      "articleSection": [
        "desenvolvimento"
      ],
      "inLanguage": "",
      "author": {
        "@type": "Person",
        "name": "Rodrigo Pinheiro"
      },
      "potentialAction": [
        {
          "@type": "CommentAction",
          "name": "Comment",
          "target": [
            "http://rpinheiro.dev/2019-05-01-feature-toggle-manager/#comments"
          ]
        }
      ]
    }
  ]
}
</script>



  <link type="text/css"
        rel="stylesheet"
        href="/css/print.css"
        media="print">

  <link type="text/css"
        rel="stylesheet"
        href="/css/poole.css">

  <link type="text/css"
        rel="stylesheet"
        href="/css/hyde.css">

  


  

  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
        integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk="
        crossorigin="anonymous" />

  <link rel="apple-touch-icon-precomposed"
        sizes="144x144"
        href="/apple-touch-icon-144-precomposed.png">

  <link rel="shortcut icon" href="/favicon.png">

  
  </head>
<body>
  <aside class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      
        
        <div class="author-image">
          <img src="/images/profile.png" class="img-circle img-headshot center" alt="Profile Picture">
        </div>
        
      

      <h1>NullPointer</h1>

      
      <p class="lead">...</p>
      
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li>
          <a href="http://rpinheiro.dev/">Home</a>
        </li>
        <li>
          <a href="/posts/">Posts</a>
        </li><li>
          <a href="/categories/">Categories</a>
        </li><li>
          <a href="/tags/">Tags</a>
        </li>
      </ul>
    </nav>

    <section class="social-icons">
      
      <a href="https://www.linkedin.com/in/rpinheiroalmeida/" rel="me" title="Linkedin" target="_blank">
        <i class="fab fa-linkedin" aria-hidden="true"></i>
      </a>
      
      <a href="https://github.com/rpinheiroalmeida" rel="me" title="GitHub" target="_blank">
        <i class="fab fa-github" aria-hidden="true"></i>
      </a>
      
      <a href="https://twitter.com/_rodrigopa_" rel="me" title="Twitter" target="_blank">
        <i class="fab fa-twitter" aria-hidden="true"></i>
      </a>
      
    </section>
  </div>
</aside>


  <main class="content container">
  <div class="post">
  <h1 class="title">Usando Toggles com Togglz e Spring Boot</h1>
  

  <div class="post-date">
    <time datetime="2019-05-01T18:00:50Z">May 1, 2019</time> &middot; 5 min read
  </div>

  <div>
  <h2 id="1introdução">1.Introdução</h2>
<p>Nossa aplicação está crescendo, queremos ter um controle maior do envio de novas funcionalidades para produção, fazer um roolback rápido de uma funcionalidade caso não esteja funcionando de acordo, realizar testes A/B de novas funcionalidades, realizar testes em produção de forma controlada e segura, habilitar fluxos distintos caso uma funcionalidade X seja utilizada pelo cliente Y ou Z. E queremos fazer tudo isso de forma simples, segura e controlada. A pergunta então é como?</p>
<p>Existe um design pattern que muitos já conhecem que é <a href="https://www.martinfowler.com/articles/feature-toggles.html">Feature Toggle</a>, que entre outras coisas, permite determinar em tempo de execução se uma determinada funcionalidade está habilitada ou não.</p>
<p>Recentemente em meu time, estamos ocupando cada vez mais o uso de Fature Toggles, com o objetivo de enviar códigos para produção de forma mais segura, possibilitando o roolback mais rápido, ou então realizar testes em produção de forma mais controlada, como por exemplo, habilitar uma nova funcionalidade apenas para um determinado IP, ou permitir o uso da nova funcionalidade apenas para 5% dos usuários.</p>
<p>A forma que fazemos isso é:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>MY_FEATURE<span style="color:#f92672">.</span><span style="color:#a6e22e">isActive</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// código da funcionalidade aqui
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p>Não sei você, mas o fato de ter <strong>IFs</strong> espalhados em todo o código me incomoda, pois o torna um pouco sujo espalhando as tomadas de decisões de novos fluxos por setores que não deveriam ser responsáveis por isso. Além de adicionar complexidade para casos que é uma feature temporária e se deseja remover o código não mais utilizado.</p>
<p>Então, como resolvemos isso? Como conseguimos eliminar os IFs por todo o código e isolar as novas funcionalidades?</p>
<p>Para isso vamos utilizar o framework <a href="https://www.togglz.org/">Togglz</a> que provê uma implementação para o design pattern Feature Toggle e é simples de usar e customizar, juntamente com Spring Boot.</p>
<h3 id="2maven-dependências">2.Maven dependências</h3>
<p>Iniciando, vamos adicionar as dependências do <em>Spring Boot</em> e <em>Togglz</em>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;dependencies&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-aop<span style="color:#f92672">&lt;/artifactId&gt;</span>
            <span style="color:#f92672">&lt;version&gt;</span>5.0.1.RELEASE<span style="color:#f92672">&lt;/version&gt;</span>
            <span style="color:#f92672">&lt;scope&gt;</span>compile<span style="color:#f92672">&lt;/scope&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.aspectj<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>aspectjweaver<span style="color:#f92672">&lt;/artifactId&gt;</span>
            <span style="color:#f92672">&lt;version&gt;</span>1.8.12<span style="color:#f92672">&lt;/version&gt;</span>
            <span style="color:#f92672">&lt;scope&gt;</span>compile<span style="color:#f92672">&lt;/scope&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.togglz<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>togglz-spring-boot-starter<span style="color:#f92672">&lt;/artifactId&gt;</span>
            <span style="color:#f92672">&lt;version&gt;</span>2.6.1.Final<span style="color:#f92672">&lt;/version&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.togglz<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>togglz-spring-security<span style="color:#f92672">&lt;/artifactId&gt;</span>
            <span style="color:#f92672">&lt;version&gt;</span>2.6.1.Final<span style="color:#f92672">&lt;/version&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#f92672">&lt;/artifactId&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-data-jpa<span style="color:#f92672">&lt;/artifactId&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-test<span style="color:#f92672">&lt;/artifactId&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>com.h2database<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>h2<span style="color:#f92672">&lt;/artifactId&gt;</span>
            <span style="color:#f92672">&lt;version&gt;</span>1.4.194<span style="color:#f92672">&lt;/version&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>
    <span style="color:#f92672">&lt;/dependencies&gt;</span>
</code></pre></div><h2 id="3togglz-configuração">3.Togglz Configuração</h2>
<p>Após adicionar as dependências criamos um enumeration que implementa a interface <em>Feature</em> e contém a lista de novas features.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">enum</span> MyFeatures <span style="color:#66d9ef">implements</span> Feature <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Label</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Employee Management Feature&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#a6e22e">@EnabledByDefault</span>
    <span style="color:#a6e22e">@DefaultActivationStrategy</span><span style="color:#f92672">(</span>id <span style="color:#f92672">=</span> SystemPropertyActivationStrategy<span style="color:#f92672">.</span><span style="color:#a6e22e">ID</span><span style="color:#f92672">,</span>
            parameters <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
                    <span style="color:#a6e22e">@ActivationParameter</span><span style="color:#f92672">(</span>
                            name <span style="color:#f92672">=</span> SystemPropertyActivationStrategy<span style="color:#f92672">.</span><span style="color:#a6e22e">PARAM_PROPERTY_NAME</span><span style="color:#f92672">,</span>
                            value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;employee.feature&#34;</span><span style="color:#f92672">),</span>
                    <span style="color:#a6e22e">@ActivationParameter</span><span style="color:#f92672">(</span>
                            name <span style="color:#f92672">=</span> SystemPropertyActivationStrategy<span style="color:#f92672">.</span><span style="color:#a6e22e">PARAM_PROPERTY_VALUE</span><span style="color:#f92672">,</span>
                            value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">})</span>
    EMPLOYEE_MANAGEMENT_FEATURE<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isActive</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> FeatureContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getFeatureManager</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isActive</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>O enum <em>MyFeature</em> define um método chamado <em>isActive()</em> que verifica quando a feature está habilitada ou não. Este comportamenteo é controlado por uma flag (<em>@EnabledByDefault</em>) e opcionalmente uma estratégia de ativação.</p>
<p>A biblioteca <em>Togglz</em> prover uma variedade de estratégias de ativação que podem ser usadas para determinar se uma feature está habilitada baseada em uma certa condição.</p>
<p>No casso da feature <em>EMPLOYEE_MANAGEMENT_FEATURE</em>, usamos <em>SystemPropertyActivationStrategy</em>, o qual avalia o estado da feature baseado no <em>System.property</em> do Java. O nome da propriedade de sistema são fornecidos através da anotação <em>ActivationParameter</em>.</p>
<p>O <em>Togglz</em> possui outras estratégias de ativação, tais como:</p>
<ul>
<li><strong>Username</strong> - que permite uma feature seja ativa por uma lista de usuários específicos.</li>
<li><strong>Userrole</strong> - utiliza a role do usuário para determina o estado da feature.</li>
<li><strong>Release Date</strong> - automaticamente ativa a feature em uma certa data e tempo.</li>
<li><strong>Gradual Rollot</strong> - habilita uma feature para uma porcentagem de usuários.</li>
<li><strong>ScriptEngine</strong> - permite utilizar um script customizado em uma linguagem suportada para determinar se a feature está ativa ou não.</li>
<li><strong>Server IP</strong> - uma feature é habilitada baseada no endereço IP.</li>
<li><strong>Custom Strategy</strong> - permite adicionar uma estratégia customizada para habilitar ou não uma feature, como por exemplo baseada em feriados.</li>
</ul>
<p>A biblioteca <em>togglz-spring-boot-starter</em> possui auto-configuração necessária para prover o bean <em>FeatureContext</em>. O único bean que precisamos definir é o <em>featureProvider</em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Configuration</span>
<span style="color:#a6e22e">@EnableJpaRepositories</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;com.core.toggle&#34;</span><span style="color:#f92672">)</span>
<span style="color:#a6e22e">@EntityScan</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;com.core.toggle&#34;</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ToggleConfiguration</span> <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Bean</span>
    <span style="color:#66d9ef">public</span> FeatureProvider <span style="color:#a6e22e">featureProvider</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> EnumBasedFeatureProvider<span style="color:#f92672">(</span>MyFeatures<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="4criando-o-aspect">4.Criando o Aspect</h2>
<p>O próximo passo será criar um Aspect que intercepta o uso da anotação FeatureToggle e verifica se a feature fornecida no parâmetro está ativa ou não.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Aspect</span>
<span style="color:#a6e22e">@Configuration</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FeaturesAspect</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> Logger logger <span style="color:#f92672">=</span> LoggerFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getLogger</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">());</span>
    <span style="color:#a6e22e">@Around</span><span style="color:#f92672">(</span>
            <span style="color:#e6db74">&#34;@within(featureAssociation) || @annotation(featureAssociation)&#34;</span>
    <span style="color:#f92672">)</span>
    <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">around</span><span style="color:#f92672">(</span>ProceedingJoinPoint joinPoint<span style="color:#f92672">,</span> FeatureAssociation featureAssociation<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Throwable <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>featureAssociation<span style="color:#f92672">.</span><span style="color:#a6e22e">value</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isActive</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> joinPoint<span style="color:#f92672">.</span><span style="color:#a6e22e">proceed</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            logger<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Feature &#34;</span> <span style="color:#f92672">+</span> featureAssociation<span style="color:#f92672">.</span><span style="color:#a6e22e">value</span><span style="color:#f92672">().</span><span style="color:#a6e22e">name</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; is not enabled!&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Resta-nos definir uma anotação chamada <strong>FeatureToggle</strong> que terá um parâmetro <em>value()</em> do tipo <em>MyFeature</em>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Target</span><span style="color:#f92672">({</span> ElementType<span style="color:#f92672">.</span><span style="color:#a6e22e">METHOD</span><span style="color:#f92672">,</span> ElementType<span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE</span> <span style="color:#f92672">})</span>
<span style="color:#a6e22e">@Retention</span><span style="color:#f92672">(</span>RetentionPolicy<span style="color:#f92672">.</span><span style="color:#a6e22e">RUNTIME</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">@interface</span> FeatureToggle <span style="color:#f92672">{</span>
    MyFeatures <span style="color:#a6e22e">value</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="5testando">5.Testando</h2>
<p>Para testar o uso da nossa estrutura de toggle vamos criar um simples exemplo que contenha uma feature para gerenciar o salário dos empregados de uma organização.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Entity</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Employee</span> <span style="color:#f92672">{</span>
 
    <span style="color:#a6e22e">@Id</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> id<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> salary<span style="color:#f92672">;</span>
     
    <span style="color:#75715e">// standard constructor, getters, setters
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">EmployeeRepository</span>
  <span style="color:#66d9ef">extends</span> CrudRepository<span style="color:#f92672">&lt;</span>Employee<span style="color:#f92672">,</span> Long<span style="color:#f92672">&gt;{</span> <span style="color:#f92672">}</span>
</code></pre></div><p>Agora, vamos adicionar um serviço que irá aumentar o salário do empregado se a feature estiver ativa, adicionando a anotação <em>@FeatureToggle</em> ao método com o parâmetro <strong>EMPLOYEE_MANAGEMENT_FEATURE</strong>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Service</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SalaryService</span> <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Autowired</span>
    EmployeeRepository employeeRepository<span style="color:#f92672">;</span>

    <span style="color:#a6e22e">@FeatureToggle</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> MyFeatures<span style="color:#f92672">.</span><span style="color:#a6e22e">EMPLOYEE_MANAGEMENT_FEATURE</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">increaseSalary</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> id<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Employee employee <span style="color:#f92672">=</span> employeeRepository<span style="color:#f92672">.</span><span style="color:#a6e22e">findById</span><span style="color:#f92672">(</span>id<span style="color:#f92672">).</span><span style="color:#a6e22e">orElse</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
        employee<span style="color:#f92672">.</span><span style="color:#a6e22e">setSalary</span><span style="color:#f92672">(</span>employee<span style="color:#f92672">.</span><span style="color:#a6e22e">getSalary</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span>
                employee<span style="color:#f92672">.</span><span style="color:#a6e22e">getSalary</span><span style="color:#f92672">()</span> <span style="color:#f92672">*</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">1</span><span style="color:#f92672">);</span>
        employeeRepository<span style="color:#f92672">.</span><span style="color:#a6e22e">save</span><span style="color:#f92672">(</span>employee<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Iremos criar o endpoint <strong>/increaseSalary</strong> para a chamada.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Controller</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SalaryController</span> <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Autowired</span>
    SalaryService salaryService<span style="color:#f92672">;</span>

    <span style="color:#a6e22e">@PostMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/increaseSalary&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#a6e22e">@ResponseBody</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">increaseSalary</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@RequestParam</span> <span style="color:#66d9ef">long</span> id<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        salaryService<span style="color:#f92672">.</span><span style="color:#a6e22e">increaseSalary</span><span style="color:#f92672">(</span>id<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Por último, vamos adicionar um teste o qual chamaremos nossa função POST após alterar o valor da propriedade <em>employee.feature</em> para falso, e nesse caso a feature não deve ser ativida e o funcionário não deve ter o aumento de salário.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Test</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">givenFeaturePropertyFalse_whenIncreaseSalary_thenNoIncrease</span><span style="color:#f92672">()</span> 
  <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
    Employee emp <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Employee<span style="color:#f92672">(</span>1<span style="color:#f92672">,</span> 2000<span style="color:#f92672">);</span>
    employeeRepository<span style="color:#f92672">.</span><span style="color:#a6e22e">save</span><span style="color:#f92672">(</span>emp<span style="color:#f92672">);</span>
     
    System<span style="color:#f92672">.</span><span style="color:#a6e22e">setProperty</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;employee.feature&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;false&#34;</span><span style="color:#f92672">);</span>
 
    mockMvc<span style="color:#f92672">.</span><span style="color:#a6e22e">perform</span><span style="color:#f92672">(</span>post<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/increaseSalary&#34;</span><span style="color:#f92672">)</span>
      <span style="color:#f92672">.</span><span style="color:#a6e22e">param</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">,</span> emp<span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">))</span>
      <span style="color:#f92672">.</span><span style="color:#a6e22e">andExpect</span><span style="color:#f92672">(</span>status<span style="color:#f92672">().</span><span style="color:#a6e22e">is</span><span style="color:#f92672">(</span>200<span style="color:#f92672">));</span>
 
    emp <span style="color:#f92672">=</span> employeeRepository<span style="color:#f92672">.</span><span style="color:#a6e22e">findOne</span><span style="color:#f92672">(</span>1L<span style="color:#f92672">);</span>
    assertEquals<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;salary incorrect&#34;</span><span style="color:#f92672">,</span> 2000<span style="color:#f92672">,</span> emp<span style="color:#f92672">.</span><span style="color:#a6e22e">getSalary</span><span style="color:#f92672">(),</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">5</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>O próximo teste é alterando a proprieda <em>employee.feature</em> para true e nesse caso o salário do empregado deve ter um acréscimo.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Test</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">givenFeaturePropertyTrue_whenIncreaseSalary_thenIncrease</span><span style="color:#f92672">()</span> 
  <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
    Employee emp <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Employee<span style="color:#f92672">(</span>1<span style="color:#f92672">,</span> 2000<span style="color:#f92672">);</span>
    employeeRepository<span style="color:#f92672">.</span><span style="color:#a6e22e">save</span><span style="color:#f92672">(</span>emp<span style="color:#f92672">);</span>
    System<span style="color:#f92672">.</span><span style="color:#a6e22e">setProperty</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;employee.feature&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">);</span>
 
    mockMvc<span style="color:#f92672">.</span><span style="color:#a6e22e">perform</span><span style="color:#f92672">(</span>post<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/increaseSalary&#34;</span><span style="color:#f92672">)</span>
      <span style="color:#f92672">.</span><span style="color:#a6e22e">param</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">,</span> emp<span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">))</span>
      <span style="color:#f92672">.</span><span style="color:#a6e22e">andExpect</span><span style="color:#f92672">(</span>status<span style="color:#f92672">().</span><span style="color:#a6e22e">is</span><span style="color:#f92672">(</span>200<span style="color:#f92672">));</span>
 
    emp <span style="color:#f92672">=</span> employeeRepository<span style="color:#f92672">.</span><span style="color:#a6e22e">findById</span><span style="color:#f92672">(</span>1L<span style="color:#f92672">).</span><span style="color:#a6e22e">orElse</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
    assertEquals<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;salary incorrect&#34;</span><span style="color:#f92672">,</span> 2200<span style="color:#f92672">,</span> emp<span style="color:#f92672">.</span><span style="color:#a6e22e">getSalary</span><span style="color:#f92672">(),</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">5</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Para finalizar, nós vimos nesse artigo como utilizar a biblioteca <em>Togglz</em> junto com Sping Boot e como verificar se a toggle está ou não habilitada.</p>
<p>O código completo está em meu <a href="https://github.com/rpinheiroalmeida/feature-toggle-manager">GitHub</a>.</p>
<p>Para referências, você pode consultar:</p>
<ul>
<li><a href="https://www.baeldung.com/spring-togglz">https://www.baeldung.com/spring-togglz</a></li>
<li><a href="https://www.togglz.org/documentation/activation-strategies.html#server-ip">https://www.togglz.org/documentation/activation-strategies.html#server-ip</a></li>
</ul>

  </div>

  <div>
  <ul class="tags">
  <li>
    <a href="http://rpinheiro.dev/tags/java/" class="tag-link">Java</a>
  </li>
  
  <li>
    <a href="http://rpinheiro.dev/tags/desenvolvimento/" class="tag-link">Desenvolvimento</a>
  </li>
  
  <li>
    <a href="http://rpinheiro.dev/tags/togglz/" class="tag-link">togglz</a>
  </li>
  
  <li>
    <a href="http://rpinheiro.dev/tags/spring-boot/" class="tag-link">spring-boot</a>
  </li>
  </ul>
</div>


  <div class="share-buttons">
  <a class="twitter-share-button"
     href="#"
     title="Share on Twitter"
     data-url="http://rpinheiro.dev/2019-05-01-feature-toggle-manager/"
     data-text="Usando Toggles com Togglz e Spring Boot"><i class="fab fa-twitter"></i></a>

  <a class="linkedin-share-button"
     href="#"
     title="Share on LinkedIn"
     data-url="http://rpinheiro.dev/2019-05-01-feature-toggle-manager/"
     data-text="Usando Toggles com Togglz e Spring Boot"><i class="fab fa-linkedin-in"></i></a>

  <a class="facebook-share-button"
     href="#"
     title="Share on Facebook"
     data-url="http://rpinheiro.dev/2019-05-01-feature-toggle-manager/"
     data-text="Usando Toggles com Togglz e Spring Boot"><i class="fab fa-facebook"></i></a>

  <a class="telegram-share-button"
     href="#"
     title="Share on Telegram"
     data-url="http://rpinheiro.dev/2019-05-01-feature-toggle-manager/"
     data-text="Usando Toggles com Togglz e Spring Boot"><i class="fab fa-telegram"></i></a>

  <a class="pinterest-share-button"
     href="#"
     title="Share on Pinterest"
     data-url="http://rpinheiro.dev/2019-05-01-feature-toggle-manager/"
     data-text="Usando Toggles com Togglz e Spring Boot"><i class="fab fa-pinterest"></i></a>
</div>

</div>


  </main>

  <footer>
  <div>
    <p>
      &copy; Rodrigo Pinheiro 2021

      &middot; <a href="https://creativecommons.org/licenses/by-sa/4.0" target="_blank">CC BY-SA 4.0</a>

      &middot; Build with <a href="https://gohugo.io/" target="_blank">Hugo</a> & <a href="https://themes.gohugo.io/soho/" target="_blank">Soho</a> theme
    </p>
  </div>
</footer>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js"
          integrity="sha256-MAgcygDRahs+F/Nk5Vz387whB4kSK9NXlDN3w58LLq0="
          crossorigin="anonymous"></script>


  <script src="/js/jquery.min.js"></script>
  <script src="/js/soho.js"></script>

  

  
</body>
</html>
